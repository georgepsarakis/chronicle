## Motivation

Chronicle is a job scheduler, designed for 12-factor apps and with operational ease in mind.

Although there are several tools for scheduling and supervising complex workflows, such as Airflow, Luigi and Celery,
Chronicle aims for solving the common issues of executing scheduled tasks.

When scheduling a task to run, one may want to define a timeout and get notified if the job exceeds it.
In addition, you may want to skip overlapping instances of the same task, or cancel the previously running one.
With regard to resources, you may want to limit concurrency, depending on the task workload (I/O bound or CPU bound).
In case of maintenance operations, you may want to pause execution, let already running tasks to complete and resume execution later,
running all pending tasks.


!!! warning
    This project is currently considered as "alpha" release.

    Configuration, API and operations may change and code coverage will improve.

## Installation

Currently only installation via GitHub is possible:

```bash
pip install git+https://github.com/georgepsarakis/chronicle.git
```

Starting from the beta release, a PyPI package will be available.

## Features

### Configurable Timeout

### Maximum Concurrency

#### Task Weight

Task weights can be used to determine each job's
contribution to the total concurrency.
This is useful for differentiating between
I/O-heavy jobs and CPU-bound jobs.  

### Backfill

In case of maintenance operations or during a deployment,
the scheduled jobs should stop running. Also, when new scheduled jobs are added there might be a need to execute the schedule
for a short period in the past.

Chronicle allows the schedule clock to be set in the past,
simply by passing a timestamp when starting the server.

### Pause / Resume

!!! important ""
    Requires use of the Redis backend.

Executions can be paused for a given interval,
or a date/time in the future. Resuming manually
is also possible.

!!! note ""
    While on pause, the scheduler clock continues to advance and already running jobs are not cancelled.

More fine grained control over which jobs will be paused
is given by providing a regular expression that will match the commands
or the job hash(es), which are generated by Chronicle and uniquely identify jobs.

### Crontab Format Export

The interval, environment variables and the command
can be exported in crontab-compatible format.
The output is useful for inspection or for migrating/deploying to
a crontab-based system.

Chronicle-specific additional metadata will also appear as comments.

### Status Checks

### Callbacks

### Event Hooks

Published events:
- `JOB_STARTED`
- `JOB_COMPLETED_SUCCESSFULLY`
- `JOB_FAILED`
- `JOB_POOL_HEARTBEAT`
- `OPERATIONS_PAUSED`
- `OPERATIONS_RESUMED`

```
{
  "id": "...",
  "type": "OPERATIONS_RESUMED",
  "details": {
      "paused_since": ""
  }
}
```

- `JOB_POOL_THROTTLING`
- `JOB_POOL_CURRENT_DELAY`

#### Adding a custom subscriber

You can add a custom event subscriber, that will be notified once new events are generated. 
The subscriber should be a callable 
that accepts a JSON-serialized event as its only argument:

```
def log_to_stderr(event):
    sys.stderr.write(f"{event}\n")

Chronicle.events.subscribe(log_to_stderr)
```

By default events are emitted as log records, in STDOUT.

### Comments

Chronicle allows for providing structured
annotations for each job.

### Metrics & Reporting

### STDOUT/STDERR Capturing

### Environment Variables

#### Environment Providers

Environment variables for each job can be retrieved
by a provider class. Note that the environment
is determined only once upon startup. 

#### Chronicle Context

#### Available Variables

- `CHRONICLE_TASK_ID`
- `CHRONICLE_CRON_TIME`
- `CHRONICLE_BACKFILL`

#### Environment Filtering

### Duplicate Command Handling

When a job execution time exceeds its interval,
processes may start piling up, requiring more resources
to complete and effectively bring execution to a halt. In addition,
the increased resource consumption (e.g. database queries),
may start causing issues to other components of the stack,
for example a web application server.

#### Skip Strategy

It is possible that the same command is configured
at different intervals or its execution time may
extend over the given interval.

Chronicle ensures that only a single instance of a command
is running at any given time.

#### Restart Strategy 

### Task Cancellation
